<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>NFT ä¸Šå‚³æ­·å²ç´€éŒ„</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/web3/dist/web3.min.js"></script>
</head>

<body class="container mt-5">
    <h2 class="mb-4">ğŸ“œ æ­·å² NFT ä¸Šå‚³ç´€éŒ„</h2>

    {% if history %}
    <div class="row">
        {% for item in history %}
        <div class="col-md-4 mb-4">
            <div class="card h-100">
                <img src="{{ item.image_path }}" class="card-img-top" alt="NFT Image">
                <div class="card-body">
                    <h5 class="card-title">{{ item.name }}</h5>
                    <p class="card-text">{{ item.description }}</p>
                    <p><strong>Metadata URI:</strong> <a href="{{ item.metadata_uri }}" target="_blank">View</a></p>
                    <p><strong>äº¤æ˜“å“ˆå¸Œ:</strong> <a href="https://etherscan.io/tx/{{ item.tx_hash }}" target="_blank">
                            {{ item.tx_hash }}</a></p>

                    <!-- è³¼è²·æŒ‰éˆ• -->
                    <button class="btn btn-success mt-3" onclick="buyNFT('{{ item.token_id }}')">è³¼è²·æ­¤ NFT</button>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <p>ç›®å‰å°šç„¡ä¸Šå‚³ç´€éŒ„ã€‚</p>
    {% endif %}

    <a href="/" class="btn btn-primary mt-4">å›é¦–é </a>

    <script>
        async function buyNFT(tokenId) {
            if (!window.ethereum) {
                alert("è«‹å®‰è£ MetaMask");
                return;
            }

            const web3 = new Web3(window.ethereum);

            try {
                await window.ethereum.request({ method: "eth_requestAccounts" });
                const accounts = await web3.eth.getAccounts();
                const buyerAddress = accounts[0];

                const response = await fetch("/buy", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ buyer_address: buyerAddress, token_id: tokenId }),
                });

                const txn = await response.json();

                if (response.status === 200) {
                    const txHash = await web3.eth.sendTransaction(txn);
                    alert(`è³¼è²·æˆåŠŸï¼äº¤æ˜“å“ˆå¸Œ: ${txHash.transactionHash}`);
                } else {
                    alert(`è³¼è²·å¤±æ•—: ${txn.error}`);
                }
            } catch (error) {
                console.error(error);
                alert(`è³¼è²·å¤±æ•—: ${error.message}`);
            }
        }
    </script>
</body>

</html>